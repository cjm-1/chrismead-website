document.addEventListener("DOMContentLoaded",initialise);class Arch{constructor(e){this.container=e,this.content=e.querySelector(".project-content"),this.toolbar=e.querySelector("#arch-parameters-form"),this.canvas=e.querySelector("#arch-drawing-area"),this.ctx=this.canvas.getContext("2d"),this.axes=e.querySelector("#arch-axes"),this.grid=e.querySelector("#arch-grid"),this.margin=50,this.drawingData={drawingHeight:void 0,drawingWidth:void 0,opening:void 0,height:void 0,skewAngle:void 0,skewLength:void 0,brickCount:void 0,baseBrickWidth:void 0,baseBrickAngle:void 0,baseJointAngle:void 0,topBrickWidth:void 0,topBrickAngle:void 0,topJointAngle:void 0,baseRise:void 0,baseRadius:void 0,baseFullAngle:void 0,baseBrickAngle:void 0,topRadius:void 0,topFullAngle:void 0,topBrickAngle:void 0,pieces:[]}}refreshCanvas(){this.generateData(),this.margin=Math.max(Math.round(this.drawingData.drawingHeight/300),Math.round(this.drawingData.drawingWidth/500))*50,this.canvas.height=this.drawingData.drawingHeight+2*this.margin,this.canvas.width=this.drawingData.drawingWidth+2*this.margin,this.drawShapes(),this.adjustAxes(),this.adjustViewport()}drawShapes(){const e=this.ctx,t=this.drawingData.pieces;e.translate(this.margin,this.margin),e.clearRect(0,0,this.canvas.width,this.canvas.height);for(let n=0;n<t.length;n++)e.beginPath(),e.lineTo(t[n].bl[0],t[n].bl[1]),e.lineTo(t[n].br[0],t[n].br[1]),e.lineTo(t[n].tr[0],t[n].tr[1]),e.lineTo(t[n].tl[0],t[n].tl[1]),e.closePath(),e.stroke()}adjustAxes(){function s(e){const t=[10,12.5,25,50];return t[e%4]*Math.pow(10,Math.floor(e/4))}function o(e,t){let a=Math.round(e/t),n=0,o=s(n),i=o;for(;o<=a;)i=o,n++,o=s(n);let r=s(n);return Math.abs(r-a)<Math.abs(i-a)?i=r:n--,i}let i=Math.max(o(this.drawingData.drawingWidth,10),o(this.drawingData.drawingHeight,8));var e=Math.max(Math.round(this.canvas.height/40),Math.round(this.canvas.width/50));this.axes.innerHTML="",this.grid.innerHTML="";const t=document.createElement("div");t.className="axis x",t.style.top=`${this.canvas.height-this.margin+1}px`,t.style.width=`${this.canvas.width}px`,this.axes.appendChild(t);const n=document.createElement("div");n.className="axis y",n.style.left=`${this.margin-2}px`,n.style.height=`${this.canvas.height}px`,this.axes.appendChild(n);for(let n=0;n<=this.canvas.width;n+=i){const t=document.createElement("div");t.className="axis-label x",t.style.left=`${this.margin+n-1}px`,t.style.top=`${this.canvas.height-this.margin+e}px`,t.style.fontSize=`${e}px`,t.innerHTML=n,this.axes.appendChild(t);const s=document.createElement("div");s.className="grid y",s.style.left=`${n+this.margin-1}px`,s.style.height=`${this.canvas.height}px`,this.grid.appendChild(s)}for(let n=0;n<=this.canvas.height;n+=i){const t=document.createElement("div");t.className="axis-label y",t.style.top=`${this.canvas.height-this.margin-n}px`,t.style.right=`${this.canvas.width-this.margin+e}px `,t.style.fontSize=`${e}px`,t.innerHTML=n,this.axes.appendChild(t);const s=document.createElement("div");s.className="grid x",s.style.top=`${this.canvas.height-n-this.margin}px`,s.style.width=`${this.canvas.width}px`,this.grid.appendChild(s)}}adjustViewport(){const t=document.body.getBoundingClientRect().height,n=this.toolbar.getBoundingClientRect().height,s=this.toolbar.getBoundingClientRect().height,i=this.canvas.parentElement.getBoundingClientRect().height;let e;this.container.classList.contains("maximised")?e=t-n-s:e=t*.6-n-s;var o=Math.min(this.content.getBoundingClientRect().width/this.canvas.width,e/this.canvas.height);this.canvas.parentElement.style.width=`${this.canvas.width}px`,this.canvas.parentElement.style.height=`${this.canvas.height}px`,this.canvas.parentElement.style.transform=`scale(${o})`,this.canvas.parentElement.style.transformOrigin="top left",this.container.querySelector("#axes-toggle-box").style.transform=`scale(${1/o})`}dumpDrawingData(){for(let e in this.drawingData)console.log(`${e}: ${this.drawingData[e]} - ${typeof this.drawingData[e]}`)}degToRad(e){return e*(Math.PI/180)}radToDeg(e){return e*(180/Math.PI)}calculateEndpoint(e,t,n,s){let o=e+n*Math.cos(s),i=t+n*Math.sin(s);return[o,i]}arcLengthToChordLength(e,t){return 2*t*Math.sin(e/(2*t))}chordLengthToArcLength(e,t){return 2*t*Math.asin(e/(2*t))}arcAngleToArcLength(e,t){return e*t}arcLengthToArcAngle(e,t){return e/t}arcLengthToTangentLength(e,t){return t*Math.tan(e/t)}tangentLengthToArcLength(e,t){return t*Math.atan(e/t)}countBricks(e,t,n,s){return(typeof s=="undefined"||!s)&&(e+=n),Math.ceil(e/(t+n))}}class FlatArch extends Arch{constructor(e){super(e),this.drawingData.baseOrigin=[void 0,void 0],this.drawingData.baseFullAngle=void 0,this.drawingData.topRise=void 0,this.drawingData.topOrigin=[void 0,void 0],this.drawingData.baseFullAngle=void 0}generateData(){let h=parseInt(this.toolbar.elements.opening.value),d=parseInt(this.toolbar.elements.height.value),j=parseInt(this.toolbar.elements.skew.value),u,x;this.toolbar.elements["skew-units-select"].value==="deg"?(x=this.degToRad(j),u=this.degToLength(j,d)):(u=j,x=this.lengthToRad(j,d));let i=h+2*u,a=parseInt(this.toolbar.elements["base-rise"].value),s,b,w;a>0&&(s=((h/2)**2/a+a)/2,b=[i/2,a-s],w=Math.atan(h/2/(s-a)));let o=parseInt(this.toolbar.elements["top-rise"].value),t,g,_;o>0&&(t=((i/2)**2/o+o)/2,g=[i/2,d+o-t],_=Math.atan(i/2/(t-o)));let y=parseInt(this.toolbar.elements["brick-width-or-count"].value),E=this.toolbar.elements["brick-division-select"].value,n=parseInt(this.toolbar.elements["joint-size"].value),e,l,r,v,p,m;if(E==="width")if(o<=0){e=this.countBricks(i,y,n,!1),this.type!=="bullseye"&&e%2===0&&e++;let t=i-n*(e-1);r=t/e,l=v="n/a"}else{p=this.chordLengthToArcLength(i,t),m=this.chordLengthToArcLength(n,t);let s=this.tangentLengthToArcLength(y,t);e=this.countBricks(p,s,m,!1),this.type!=="bullseye"&&e%2===0&&e++}else e=y,E==="count"&&(p=this.chordLengthToArcLength(i,t),m=this.chordLengthToArcLength(n,t));if(o<=0){let t=i-(e-1)*n;r=t/e}else{let n=p-m*(e-1),s=n/e;l=this.arcLengthToArcAngle(s,t),r=this.arcLengthToTangentLength(this.arcAngleToArcLength(l,t),t),v=this.arcLengthToArcAngle(m,t)}let k,O,f,c,C;if(a<=0){let t=h-(e-1)*n;c=t/e}else{k=this.chordLengthToArcLength(h,s),O=this.chordLengthToArcLength(n,s);let t=k-O*(e-1),o=t/e;f=this.arcLengthToArcAngle(o,s),c=this.arcLengthToTangentLength(this.arcAngleToArcLength(f,s),s),C=this.arcLengthToArcAngle(O,s)}if(this.drawingData.drawingHeight=d+o,this.drawingData.drawingWidth=i,this.drawingData.opening=h,this.drawingData.height=d,this.drawingData.skewLength=u,this.drawingData.skewAngle=x,this.drawingData.baseRise=a,a&&(this.drawingData.baseRadius=s,this.drawingData.baseOrigin=b,this.drawingData.baseFullAngle=w*2,this.drawingData.baseBrickAngle=f),this.drawingData.topRise=o,o&&(this.drawingData.topRadius=t,this.drawingData.topOrigin=g,this.drawingData.topFullAngle=_*2,this.drawingData.topBrickAngle=l),this.drawingData.brickCount=e,this.drawingData.baseBrickWidth=c,this.drawingData.topBrickAngle=l,this.drawingData.topBrickWidth=r,this.drawingData.topBrickAngle=l,this.drawingData.baseJointAngle=C,this.drawingData.topJointAngle=v,this.drawingData.pieces=[],a<=0)for(let t=0;t<e;t++){let s={};s.bl=[u+(c+n)*t,0],s.br=[u+(c+n)*t+c,0],this.drawingData.pieces.push(s)}else{let t=Math.PI/2+w-f/2;for(let o=0;o<e;o++){let n={};n.bc=this.calculateEndpoint(b[0],b[1],s,t),n.bl=this.calculateEndpoint(n.bc[0],n.bc[1],c/2,t+Math.PI/2),n.br=this.calculateEndpoint(n.bc[0],n.bc[1],c/2,t-Math.PI/2),this.drawingData.pieces.push(n),t-=f+C}}if(o<=0)for(let t=0;t<e;t++)this.drawingData.pieces[t].tl=[(r+n)*t,d],this.drawingData.pieces[t].tr=[(r+n)*t+r,d];else{let n=Math.PI/2+_-l/2;for(let s=0;s<e;s++){let o=this.calculateEndpoint(g[0],g[1],t,n);this.drawingData.pieces[s].tc=o,this.drawingData.pieces[s].tl=this.calculateEndpoint(o[0],o[1],r/2,n+Math.PI/2),this.drawingData.pieces[s].tr=this.calculateEndpoint(o[0],o[1],r/2,n-Math.PI/2),n-=l+v}}}traceOutline(){const t=this.ctx,e=this.drawingData;t.translate(this.margin,this.margin),t.clearRect(0,0,this.canvas.width,this.canvas.height),t.beginPath(),t.lineTo(e.skewLength,0),e.baseRise==0?t.lineTo(e.skewLength+e.opening,0):t.arc(e.baseOrigin[0],e.baseOrigin[1],e.baseRadius,Math.PI/2+e.baseFullAngle/2,Math.PI/2-e.baseFullAngle/2,!0),t.lineTo(e.opening+e.skewLength*2,e.height),e.topRise==0?t.lineTo(0,e.height):t.arc(e.topOrigin[0],e.topOrigin[1],e.topRadius,Math.PI/2-e.topFullAngle/2,Math.PI/2+e.topFullAngle/2),t.closePath(),t.stroke()}degToLength(e,t){return Math.tan(this.degToRad(e))*t}radToLength(e,t){return Math.tan(e)*t}lengthToDeg(e,t){return this.radToDeg(lengthToRad(e,t))}lengthToRad(e,t){return Math.atan(e/t)}}class RadialArch extends Arch{constructor(e,t){super(e),this.type=t,this.drawingData.rise=void 0,this.drawingData.skewAngle=void 0,this.drawingData.skewLength=void 0,this.drawingData.origin=void 0,this.drawingData.fullAngle=void 0,this.drawingData.baseRadius=void 0,this.drawingData.topRadius=void 0}generateData(){let o=parseInt(this.toolbar.elements.opening.value),a=parseInt(this.toolbar.elements.height.value),i,e,t,n,r,s,l,h,m;switch(this.type){case"radial":let c=parseInt(this.toolbar.elements["rise-or-skew"].value);switch(this.toolbar.elements["rise-or-skew-select"].value){case"rise":i=c,i>0?(e=((o/2)**2/i+i)/2,t=e!="n/a"?e+a:"n/a",n=Math.atan(o/2/(e-i)),r=this.radToLength(n,a),s=[o/2+r,i-e],l=n*2):(r=n=l=0,e=t=s="n/a");break;case"deg":n=this.degToRad(c),n>0?(l=n*2,r=this.radToLength(n,a),e=o/2/Math.sin(n),t=e!="n/a"?e+a:"n/a",i=e-o/2/Math.tan(n),l=n*2,s=[o/2+r,i-e]):(r=n=l=i=0,e=t=s="n/a");break;case"mm":r=c,r>0?(n=this.lengthToRad(r,a),e=o/2/Math.sin(n),t=e!="n/a"?e+a:"n/a",i=e-o/2/Math.tan(n),l=n*2,s=[o/2+r,i-e]):(r=n=l=i=0,e=t=s="n/a");break;default:}h=this.calculateEndpoint(s[0],s[1],t,Math.PI/2-n)[0],m=this.calculateEndpoint(s[0],s[1],t,Math.PI/2)[1];break;case"semicircle":e=o/2,t=e!="n/a"?e+a:"n/a",n=this.degToRad(90),r=a,i=o/2,s=[t,0],l=Math.PI,h=2*t,m=t;break;case"bullseye":e=o/2,t=e!="n/a"?e+a:"n/a",n=this.degToRad(180),r=0,i=o+a,s=[t,t],l=2*Math.PI,h=2*t,m=2*t;break;default:}let E=parseInt(this.toolbar.elements["brick-width-or-count"].value),M=this.toolbar.elements["brick-division-select"].value,x=parseInt(this.toolbar.elements["joint-size"].value),c,y=this.arcAngleToArcLength(l,t),v=this.tangentLengthToArcLength(x,t);if(M==="width"){let e=this.tangentLengthToArcLength(E,t);c=this.countBricks(y,e,v,this.type==="bullseye"),this.type!=="bullseye"&&c%2===0&&c++}else c=E;let A=y-(this.type==="bullseye"?c:c-1)*v,C=A/c,g=this.arcLengthToTangentLength(C,t),p=this.arcLengthToArcAngle(C,t),_=this.arcLengthToArcAngle(v,t),k=this.arcAngleToArcLength(l,e),j=this.tangentLengthToArcLength(x,e),w=this.arcLengthToArcAngle(j,e),S=k-(this.type==="bullseye"?c:c-1)*j,O=S/c,f=this.arcLengthToArcAngle(O,e),b=this.arcLengthToTangentLength(O,e);this.drawingData.drawingWidth=h,this.drawingData.drawingHeight=m,this.drawingData.opening=o,this.drawingData.height=a,this.drawingData.rise=i,this.drawingData.skewAngle=n,this.drawingData.skewLength=r,this.drawingData.baseRadius=e,this.drawingData.topRadius=t,this.drawingData.origin=s,this.drawingData.fullAngle=l,this.drawingData.brickCount=c,this.drawingData.baseBrickWidth=b,this.drawingData.topBrickWidth=g,this.drawingData.baseBrickAngle=f,this.drawingData.topBrickAngle=p,this.drawingData.baseJointAngle=w,this.drawingData.topJointAngle=_,this.drawingData.pieces=[];let u=Math.PI/2+n-f/2,d=Math.PI/2+n-p/2;this.type==="bullseye"&&(u-=Math.PI-f/2,d-=Math.PI-p/2);for(let i=0;i<c;i++){let n={};n.baseAngle=u,n.topAngle=d,n.bc=this.calculateEndpoint(s[0],s[1],e,u),n.tc=this.calculateEndpoint(s[0],s[1],t,d),this.type!=="semicircle"||i>0?(n.bl=this.calculateEndpoint(n.bc[0],n.bc[1],b/2,u+Math.PI/2),n.tl=this.calculateEndpoint(n.tc[0],n.tc[1],g/2,d+Math.PI/2)):(n.bl=[a,0],n.tl=[0,0]),this.type!=="semicircle"||i<c-1?(n.br=this.calculateEndpoint(n.bc[0],n.bc[1],b/2,u-Math.PI/2),n.tr=this.calculateEndpoint(n.tc[0],n.tc[1],g/2,d-Math.PI/2)):(n.br=[a+o,0],n.tr=[2*a+o,0]),this.drawingData.pieces.push(n),u-=f+w,d-=p+_}}traceOutline(){const t=this.ctx,e=this.drawingData;switch(t.translate(this.margin,this.margin),t.clearRect(0,0,this.canvas.width,this.canvas.height),this.type){case"radial":t.beginPath();let n=this.calculateEndpoint(e.origin[0],e.origin[1],e.baseRadius,Math.PI/2+e.skewAngle);t.lineTo(n[0],n[1]),t.arc(e.origin[0],e.origin[1],e.baseRadius,Math.PI/2+e.skewAngle,Math.PI/2-e.skewAngle,!0);let s=this.calculateEndpoint(e.origin[0],e.origin[1],e.topRadius,Math.PI/2-e.skewAngle);t.lineTo(s[0],s[1]),t.arc(e.origin[0],e.origin[1],e.topRadius,Math.PI/2-e.skewAngle,Math.PI/2+e.skewAngle),t.closePath(),t.stroke();break;case"semicircle":t.beginPath(),t.lineTo(0,0),t.lineTo(e.height,0),t.arc(e.origin[0],e.origin[1],e.baseRadius,Math.PI/2+e.fullAngle/2,Math.PI/2-e.fullAngle/2,!0),t.lineTo(2*e.topRadius,0),t.arc(e.origin[0],e.origin[1],e.topRadius,Math.PI/2-e.fullAngle/2,Math.PI/2+e.fullAngle/2),t.stroke();break;case"bullseye":t.beginPath(),t.arc(e.origin[0],e.origin[1],e.baseRadius,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(e.origin[0],e.origin[1],e.topRadius,0,2*Math.PI),t.stroke();break;default:}console.log(`Skew angle: ${this.radToDeg(e.skewAngle)}`);let n=Math.PI/2+e.skewAngle-e.brickAngle/2;for(let i=0;i<e.brickCount;i++){let s=this.calculateEndpoint(e.origin[0],e.origin[1],e.baseRadius,n),a=this.calculateEndpoint(s[0],s[1],e.baseBrickWidth/2,n+Math.PI/2),r=this.calculateEndpoint(s[0],s[1],e.baseBrickWidth/2,n-Math.PI/2),o=this.calculateEndpoint(e.origin[0],e.origin[1],e.topRadius,n),c=this.calculateEndpoint(o[0],o[1],e.topBrickWidth/2,n+Math.PI/2),l=this.calculateEndpoint(o[0],o[1],e.topBrickWidth/2,n-Math.PI/2);t.beginPath(),t.strokeStyle="red",t.setLineDash([]),t.lineTo(a[0],a[1]),t.lineTo(c[0],c[1]),t.stroke(),t.beginPath(),t.strokeStyle="blue",t.setLineDash([5,15]),t.lineTo(s[0],s[1]),t.lineTo(o[0],o[1]),t.stroke(),t.beginPath(),t.strokeStyle="red",t.setLineDash([]),t.lineTo(r[0],r[1]),t.lineTo(l[0],l[1]),t.stroke(),n-=e.brickAngle+e.jointAngle}}degToLength(e,t){return Math.sin(this.degToRad(e))*t}radToLength(e,t){return Math.sin(e)*t}lengthToDeg(e,t){return this.radToDeg(lengthToRad(e,t))}lengthToRad(e,t){return Math.asin(e/t)}}function initialise(){const t=document.getElementById("arch"),o=document.getElementById("arch-type-toolbar-select"),i=document.getElementById("brick-division-toolbar-select"),a=document.getElementById("rise-or-skew-toolbar-select"),r=new ResizeObserver(()=>{const e=document.getElementById("arch-type-toolbar-select").value;let t=s(e);t.refreshCanvas()});r.observe(t);let e;o.addEventListener("change",t=>{e=s(t.target.value),c(t.target.value)}),i.addEventListener("change",e=>{switch(e.target.value){case"width":e.target.parentElement.querySelector("label").innerText="Brick width:";break;case"count":e.target.parentElement.querySelector("label").innerText="Number of bricks:"}}),a.addEventListener("change",e=>{switch(e.target.value){case"rise":e.target.parentElement.querySelector("label").innerText="Rise:";break;case"deg":case"mm":e.target.parentElement.querySelector("label").innerText="Skew:"}}),document.getElementById("axes-visibility-chk").addEventListener("change",e=>{document.getElementById("arch-axes").style.visibility=e.target.checked?"visible":"hidden"}),document.getElementById("grid-visibility-chk").addEventListener("change",e=>{document.getElementById("arch-grid").style.visibility=e.target.checked?"visible":"hidden"}),document.querySelectorAll(".project-window-minimise").forEach(e=>{e.addEventListener("change",e=>{const n=e.target.parentElement.parentElement.parentElement,s=e.target.parentElement.querySelector(".project-window-maximise"),o=n.querySelector(".project-content");s.checked&&(s.checked=!1,n.classList.remove("maximised")),e.target.checked?(t.classList.add("minimised"),o.classList.add("minimised")):(t.classList.remove("minimised"),o.classList.remove("minimised"))})}),document.querySelectorAll(".project-window-maximise").forEach(t=>{t.addEventListener("change",t=>{const n=t.target.parentElement.parentElement.parentElement,s=t.target.parentElement.querySelector(".project-window-minimise"),o=n.querySelector(".project-content");s.checked&&(s.checked=!1,o.classList.remove("minimised")),t.target.checked?n.classList.add("maximised"):n.classList.remove("maximised"),e.refreshCanvas()})}),document.querySelectorAll(".project-window-close").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.parentElement.parentElement.querySelector("h2").innerText;confirm(`Really close ${t}?
You will need to refresh the page to use it again.`)&&e.target.parentElement.parentElement.parentElement.remove()})}),document.getElementById("brick-arch-content").addEventListener("transitionend",e=>{e.propertyName=="transform"&&e.target.style.transform=="scaleY(1)"&&n()});function n(){e&&e.refreshCanvas()}function c(t){e.toolbar.querySelectorAll(".arch-toolbar-item").forEach(e=>{e.classList.add("hidden")});let n;switch(t){case"flat":n=".flat-toolbar-item",e.toolbar.querySelector("#opening-toolbar-item label").innerText="Base width:";break;case"radial":n=".radial-toolbar-item",e.toolbar.querySelector("#opening-toolbar-item label").innerText="Opening:";break;case"semicircle":n=".semicircle-toolbar-item",e.toolbar.querySelector("#opening-toolbar-item label").innerText="Opening:";break;case"bullseye":n=".bullseye-toolbar-item",e.toolbar.querySelector("#opening-toolbar-item label").innerText="Inner diameter:";break;default:n=""}e.toolbar.querySelectorAll(n).forEach(e=>{e.classList.remove("hidden")})}function s(e){switch(e){case"flat":return new FlatArch(t);case"radial":case"semicircle":case"bullseye":return new RadialArch(t,e);default:console.error("Unknown arch type.")}}Array.prototype.forEach.call(document.getElementById("arch-parameters-form").elements,e=>{e.addEventListener("change",n)}),e=s(o.value),n()}